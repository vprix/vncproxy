# 图块游程编码 TRLE

TRLE（Tiled Run-Length Encoding），使用图块压缩技术、调色板技术以及游程编码，对传输的桌面图像进行压缩。

在图块压缩技术中，传输图像被分为 N 个 16x16  的小图块，图块按从左到右，从上到下的顺序排列成一位数组。如果传输图像的尺寸不是 16 的整数倍，最后一列/最后一行图块的宽度/高度应为实际宽度/实际高度（小于16）。

TRLE 使用 CPIXEL(compressed pixel) 表示像素。CPIXEL 同样由 [PIXEL_FORMAT](/rfc6143/transfer/pixel-format.md) 定义。
在特殊情况下，CPIXEL 使用更紧凑的结构表示像素。
假如 PIXEL_FORMAT 中 true-color-flag 是非零值，bits-per-pixel 是 32，depth 是 24 或更小，只会用低 3 bit 或者高 3 bit 来表达红、绿、蓝。

## 子编码

图块使用头部单字节表示图块的子编码类型。
子编码类型的最高比特表示当前图块是否使用游程编码。
低 7-bit 指示调色板的大小。

```
+---------------+--------------+------------------+
| No. of bits   | Type [Value] | Description      |
+------------------------------+------------------+
| 1             | bit          | run-length-flag  |
| 2-8           | bit          | palette-length   |
+------------------------------+------------------+
```

TRLE 对自编码的值有单独定义

| 十六进制        | 十进制       | 含义                            |
|-------------|-----------|-------------------------------|
| 0x00        | 0         | [Raw 模式](#raw-模式)，不使用游程和调色板   |
| 0x01        | 1         | [纯色模式](#纯色模式)，图块使用同一种颜色       |
| 0x02 - 0x10 | 2 - 16    | [打包像素调色板模式](#打包像素调色板模式)       |
| 0x11 - 0x7E | 17 - 126  | 保留                            |
| 0x7F        | 127       | [打包像素调色板模式](#打包像素调色板模式)，复用调色板 |
| 0x80        | 128       | [RLE 模式](#rle-模式)             |
| 0x81        | 129       | [调色板游程编码](#调色板游程编码)，复用调色板     |
| 0x82 - 0xFF | 130 - 255 | [调色板游程编码](#调色板游程编码)           |



### Raw 模式

Raw 模式直接传输像素值，像素在图块中按从左到右、从上到下排列。不使用游程编码，不使用调色板。

```
+-----------------------------+----------------+--------------+
| No. of bytes                | Type [Value]   | Description  |
+-----------------------------+----------------+--------------+
|                           1 | SubEncoding[0] | sub-encoding |
| width*height*BytesPerCPixel | CPIXEL array   | pixels       |
+-----------------------------+----------------+--------------+
```

### 纯色模式

图块使用同一种颜色。

```
+----------------+----------------+--------------+
| No. of bytes   | Type [Value]   | Description  |
+----------------+----------------+--------------+
|              1 | SubEncoding[1] | sub-encoding |
| bytesPerCPixel | CPIXEL         | pixelValue   |
+----------------+----------------+--------------+
```

### 打包像素调色板模式

打包像素调色板模式。使用调色板定义颜色，使用颜色在调色板中的偏移量表达颜色。由于调色板较小，可以将多个像素的色值打包到一个字节中存储，进一步压缩体积。

每个像素使用的 bit 数由调色板大小确定，N=log2 M。
如果像素的数量不是 2/4/8 的倍数，需要添加填充位，对齐字节。

| 调色板大小 | 像素比特数 | 打包后字节数                      |
|:-----:|:-----:|-----------------------------|
|  =2   |   1   | m = (width+7) // 8 *height  |
|  <=4  |   2   | m = (width+3) // 4 * height |
| <=16  |   4   | m = (width+1) // 2 * height |

```
+----------------------------+--------------+--------------+
| No. of bytes               | Type [Value] | Description  |
+----------------------------+--------------+--------------+
|                          1 | SubEncoding  | sub-encoding |
| paletteSize*bytesPerCPixel | CPIXEL array | palette      |
| m                          | U8 array     | packedPixels |
+----------------------------+--------------+--------------+
```

### RLE 模式

RLE 模式，不使用调色板，使用游程编码。在计算游程时，允许跨行计算。
长度由一个或多个字节表示，到第一个不是 255（0xFF）停止。

```
+-------------------------+------------------+-----------------------+
| No. of bytes            | Type [Value]     | Description           |
+-------------------------+------------------+-----------------------+
|                       1 | SubEncoding[128] | sub-encoding          |
| bytesPerCPixel          | CPIXEL           | pixelValue            |
| div(runLength - 1, 255) | U8 array         | 255                   |
| 1                       | U8               | (runLength-1) mod 255 |
+-------------------------+------------------+-----------------------+
```

例如：

| 游程长度 |   字节表示   |
|:----:|:--------:|
|  1   |   0x00   |
| 255  |   0xFE   |
| 256  |  0xFF00  |
| 257  |  0xFF01  |
| 510  |  0xFFFE  |
| 511  | 0xFFFF00 |


### 调色板游程编码

调色板游程编码。使用调色板，游程部分类似[RLE 模式](#rle-模式)，将像素放入数组后，使用像素加游程的方式表示整个色块，像素用调色板偏移量表示。

```
+----------------------------+--------------+--------------+
| No. of bytes               | Type [Value] | Description  |
+----------------------------+--------------+--------------+
|                          1 | SubEncoding  | sub-encoding |
| paletteSize*bytesPerCPixel | CPIXEL array | palette      |
+----------------------------+--------------+--------------+
```


- 长度为1的游程，仅由调色板索引表示

```
+--------------+--------------+--------------+
| No. of bytes | Type [Value] | Description  |
+--------------+--------------+--------------+
| 1            | U8           | paletteIndex |
+--------------+--------------+--------------+
```

- 长度大于1的游程，由调色板索引+128和游程长度表示

```
+-------------------------+--------------+-----------------------+
| No. of bytes            | Type [Value] | Description           |
+-------------------------+--------------+-----------------------+
| 1                       | U8           | paletteIndex + 128    |
| div(runLength - 1, 255) | U8 array     | 255                   |
| 1                       | U8           | (runLength-1) mod 255 |
+-------------------------+--------------+-----------------------+
```
